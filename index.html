<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Church Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2c3e50">
  <link rel="apple-touch-icon" href="church logo/New Logo 2026.png">
  <style>
    :root {
      --primary-blue: #2c3e50;
      --secondary-blue: #3498db;
      --white: #ffffff;
      --light-gray: #f4f7f6;
      --success-green: #27ae60;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--white) 100%);
    }

    .container {
      background: var(--white);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 450px;
      margin: 20px;
      transition: all 0.3s ease;
    }

    .header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding: 2rem;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--primary-blue) 100%);
      position: relative;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
    }

    .header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: 
        repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(255,255,255,.05) 35px, rgba(255,255,255,.05) 70px);
      pointer-events: none;
      z-index: 1;
    }

    .header::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      z-index: 2;
    }

    .header > * {
      position: relative;
      z-index: 2;
    }

    .header-text {
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.12);
      backdrop-filter: blur(8px);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.2);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .header-text::before {
      content: '';
      position: absolute;
      top: 0;
      left: 10%;
      right: 10%;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      border-radius: 10px 10px 0 0;
    }

    .header-text::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 10%;
      right: 10%;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      border-radius: 0 0 10px 10px;
    }

    .logo {
      max-width: 100px;
      height: auto;
      margin-bottom: 0.5rem;
      background: var(--primary-blue);
      padding: 8px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    h1 {
      color: var(--white);
      font-size: 1.4rem;
      margin: 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
    }

    .slogan {
      color: var(--white);
      font-size: 0.9rem;
      margin-top: 5px;
      font-weight: 500;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-weight: 600;
      color: var(--primary-blue);
      font-size: 0.85rem;
    }

    input[type="text"],
    input[type="tel"],
    input[type="number"],
    input[type="radio"],
    input[type="checkbox"],
    input[type="select"],
    select,
    textarea {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      box-sizing: border-box;
    }

    select {
      width: 100%;
      height: auto;
      padding: 10px;
    }

    input[type="radio"],
    input[type="checkbox"] {
      width: auto;
      height: auto;
      padding: 0;
      margin: 0;
    }

    .birthday-group {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .birthday-group input {
      width: 100%;
    }

    textarea {
      height: 60px;
      resize: vertical;
    }

    .checkbox-group {
      display: flex;
      flex-direction: row !important;
      align-items: center;
      gap: 10px;
      margin-top: 5px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
    }

    .checkbox-group input {
      width: 18px;
      height: 18px;
    }

    button {
      background: var(--secondary-blue);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    #confirmation {
      display: none;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .details-card {
      background: var(--light-gray);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .details-card ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .details-card li {
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    /* Full-screen Blessing Overlay */
    #fullBlessingOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--white) 100%);
      z-index: 2000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 1rem;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .blessing-content {
      max-width: 500px;
      width: 95%;
      background: rgba(255, 255, 255, 0.95);
      padding: 3rem 2rem;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      animation: zoomIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes zoomIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .blessing-logo {
      max-width: 150px;
      margin-bottom: 2rem;
    }

    .thank-you-note {
      color: var(--success-green);
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    .blessing-text {
      font-size: 1.4rem;
      font-style: italic;
      color: var(--primary-blue);
      line-height: 1.6;
      margin: 2rem 0;
      padding: 0 1rem;
    }

    .slogan-footer {
      color: var(--secondary-blue);
      font-weight: 600;
      margin-top: 2rem;
      font-size: 1.1rem;
    }

    .done-btn {
      margin-top: 3rem;
      padding: 15px 40px;
      font-size: 1.2rem;
      background: var(--success-green);
    }

    @media (max-width: 480px) {
      .container { padding: 1.5rem; }
      h1 { font-size: 1.25rem; }
      .thank-you-note { font-size: 1.5rem; }
      .blessing-text { font-size: 1.1rem; }
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <img src="church logo/New Logo 2026.png" alt="Church Logo" class="logo">
      <div class="header-text">
        <h1>Church Registration</h1>
        <div class="slogan">An encounter with the Holy Spirit</div>
      </div>
    </div>

    <form id="registrationForm">
      <div class="form-group">
        <label for="name">Full Name</label>
        <input type="text" id="name" placeholder="Enter your name" required>
      </div>

      <div class="form-group">
        <label for="phone">Phone Number</label>
        <input type="tel" id="phone" placeholder="e.g. 0700000000" required>
      </div>

      <div class="form-group">
        <label for="location">Location</label>
        <input type="text" id="location" placeholder="Where do you live?" required>
      </div>

      <div class="form-group">
        <label>Birthday (Month & Day)</label>
        <div class="birthday-group">
          <div>
            <input type="number" id="birthMonth" placeholder="Month (1-12)" min="1" max="12">
          </div>
          <div>
            <input type="number" id="birthDay" placeholder="Day (1-31)" min="1" max="31">
          </div>
        </div>
      </div>

      <div class="form-group">
        <label for="whatsapp">WhatsApp Number (Optional)</label>
        <input type="tel" id="whatsapp" placeholder="e.g. 0700000000">
      </div>

      <div class="form-group">
        <label>Is this your first time visiting?</label>
        <div class="checkbox-group" style="gap: 20px;">
          <label style="cursor: pointer;">
            <input type="radio" name="firstTime" value="yes"> Yes, first time
          </label>
          <label style="cursor: pointer;">
            <input type="radio" name="firstTime" value="no" checked> No, returning
          </label>
        </div>
      </div>

      <div class="form-group" id="volunteerSection" style="display: none;">
        <label>How can you serve? (Optional)</label>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; background: #f8f9fa; padding: 10px; border-radius: 6px;">
          <label style="cursor: pointer; display: flex; gap: 8px;">
            <input type="checkbox" id="vol-worship" value="Worship/Music"> Worship/Music
          </label>
          <label style="cursor: pointer; display: flex; gap: 8px;">
            <input type="checkbox" id="vol-youth" value="Youth Ministry"> Youth Ministry
          </label>
          <label style="cursor: pointer; display: flex; gap: 8px;">
            <input type="checkbox" id="vol-outreach" value="Outreach"> Outreach
          </label>
          <label style="cursor: pointer; display: flex; gap: 8px;">
            <input type="checkbox" id="vol-counseling" value="Counseling"> Counseling
          </label>
          <label style="cursor: pointer; display: flex; gap: 8px;">
            <input type="checkbox" id="vol-teaching" value="Teaching"> Teaching
          </label>
          <label style="cursor: pointer; display: flex; gap: 8px;">
            <input type="checkbox" id="vol-other" value="Other"> Other
          </label>
        </div>
      </div>

      <div class="form-group checkbox-group">
        <input type="checkbox" id="consent" checked>
        <label for="consent" style="cursor: pointer;">Agree to be added to WhatsApp & receive messages</label>
      </div>

      <div class="form-group">
        <label for="prayers">Prayer Requests (Optional)</label>
        <textarea id="prayers" placeholder="Tell us how we can pray for you..."></textarea>
      </div>

      <button type="submit" id="submitBtn">Done Registering</button>
    </form>

    <div id="confirmation">
      <div style="text-align: center;">
        <h2 style="color: var(--primary-blue); margin-top: 0;">Confirm Your Details</h2>
        <p>Ensure your information is correct before saving.</p>
      </div>
      <div class="details-card">
        <ul id="detailsList"></ul>
      </div>
      <button id="saveBtn" style="width: 100%; background: var(--success-green); margin-bottom: 10px;">Save Registration</button>
      <button id="editBtn" style="width: 100%; background: var(--primary-blue);">Edit Details</button>
    </div>
  </div>

  <div id="fullBlessingOverlay">
    <div class="blessing-content">
      <img src="church logo/New Logo 2026.png" alt="Church Logo" class="blessing-logo">
      <div class="thank-you-note">Thank You for Registering!</div>
      <p id="blessingText" class="blessing-text"></p>
      <div class="slogan-footer">An encounter with the Holy Spirit</div>
      <button class="done-btn" onclick="closeBlessing()">Amen</button>
    </div>
  </div>

  <script>
    const REGISTER_API_URL = 'https://script.google.com/macros/s/AKfycbzKAdobj59rI5uvPI5PK73fNmswL1_bzYC2zUBUtw7Tj5nAXLhqa4uzByTfwClnxI3AxQ/exec';
    const GET_DATA_API_URL = 'https://script.google.com/macros/s/AKfycbzKAdobj59rI5uvPI5PK73fNmswL1_bzYC2zUBUtw7Tj5nAXLhqa4uzByTfwClnxI3AxQ/exec';
    
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const confirmation = document.getElementById('confirmation');
    const detailsList = document.getElementById('detailsList');
    const saveBtn = document.getElementById('saveBtn');
    const editBtn = document.getElementById('editBtn');
    const fullBlessingOverlay = document.getElementById('fullBlessingOverlay');
    
    let currentEntry = null;
    let allRegistrations = [];
    let churchPrograms = {
      sunday: "8:00 AM",
      monday: "7:00 AM - 9:00 AM",
      wednesday: "Evening Glory 5pm-7pm",
      tueThu: "7:00 AM - 3:00 PM",
      friday: "3pm, 2am, 3am (Not overnight)"
    };

    // Pre-fetch registrations & programs
    async function prefetchData() {
      try {
        const response = await fetch(GET_DATA_API_URL);
        if (response.ok) {
          const data = await response.json();
          allRegistrations = data.filter(reg => reg.name !== "SYSTEM_PROGRAMS");
          
          const progData = data.find(reg => reg.name === "SYSTEM_PROGRAMS");
          if (progData && progData.location) {
            try {
              churchPrograms = JSON.parse(progData.location);
              // Ensure wednesday exists for old saved programs
              if (!churchPrograms.wednesday) churchPrograms.wednesday = "Evening Glory 5pm-7pm";
            } catch (e) { console.error("Error parsing programs", e); }
          }
        }
      } catch (e) {
        console.error("Could not fetch existing data", e);
      }
    }
    prefetchData();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW registration failed', err));
      });
    }

    function handleReview(e) {
      e.preventDefault();
      
      const prayerText = document.getElementById('prayers').value;
      const prayerList = prayerText.split('\n').filter(line => line.trim() !== "");

      // Format name: First Letter Capital, others small for each word
      const rawName = document.getElementById('name').value.trim();
      const formattedName = rawName.toLowerCase()
        .split(' ')
        .filter(word => word.length > 0)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');

      const birthMonth = document.getElementById('birthMonth').value.trim();
      const birthDay = document.getElementById('birthDay').value.trim();

      // Get volunteer interests
      const volunteering = [];
      const volCheckboxes = document.querySelectorAll('input[id^="vol-"]:checked');
      volCheckboxes.forEach(cb => {
        if (cb.value) volunteering.push(cb.value);
      });

      const firstTimeValue = document.querySelector('input[name="firstTime"]:checked')?.value || "no";

      currentEntry = {
        name: formattedName,
        phone: document.getElementById('phone').value.trim(),
        location: document.getElementById('location').value.trim(),
        birthMonth: birthMonth || null,
        birthDay: birthDay || null,
        whatsapp: document.getElementById('whatsapp').value.trim() || null,
        firstTime: firstTimeValue,
        volunteering: volunteering,
        consent: document.getElementById('consent').checked,
        prayers: prayerList
      };

      showConfirmation(currentEntry);
    }

    function isUpcomingBirthday(month, day) {
      if (!month || !day) return false;
      const today = new Date();
      const currentMonth = today.getMonth() + 1;
      const currentDay = today.getDate();
      
      let daysUntilBirthday;
      if (month > currentMonth || (month === currentMonth && day > currentDay)) {
        daysUntilBirthday = new Date(today.getFullYear(), month - 1, day) - today;
      } else {
        daysUntilBirthday = new Date(today.getFullYear() + 1, month - 1, day) - today;
      }
      
      const daysDiff = Math.ceil(daysUntilBirthday / (1000 * 60 * 60 * 24));
      return daysDiff <= 7 && daysDiff > 0;
    }

    form.addEventListener('submit', handleReview);
    editBtn.addEventListener('click', () => {
      form.style.display = "flex";
      confirmation.style.display = "none";
    });

    document.querySelectorAll('input[name="firstTime"]').forEach(radio => {
      radio.addEventListener('change', (e) => {
        const volunteerSection = document.getElementById('volunteerSection');
        if (e.target.value === 'yes') {
          volunteerSection.style.display = 'block';
        } else {
          volunteerSection.style.display = 'none';
          document.querySelectorAll('#volunteerSection input[type="checkbox"]').forEach(cb => cb.checked = false);
        }
      });
    });

    const WEEKLY_VERSES = [
      "The Lord bless you and keep you; the Lord make his face shine on you and be gracious to you. (Numbers 6:24-25)",
      "For I know the plans I have for you, declares the Lord, plans to prosper you and not to harm you. (Jeremiah 29:11)",
      "The Lord is my shepherd; I shall not want. He makes me lie down in green pastures. (Psalm 23:1-2)",
      "Trust in the Lord with all your heart and lean not on your own understanding. (Proverbs 3:5)",
      "But those who hope in the Lord will renew their strength. They will soar on wings like eagles. (Isaiah 40:31)",
      "The Lord your God is with you, the Mighty Warrior who saves. He will take great delight in you. (Zephaniah 3:17)",
      "I can do all this through him who gives me strength. (Philippians 4:13)",
      "And my God will meet all your needs according to the riches of his glory in Christ Jesus. (Philippians 4:19)"
    ];

    function getWeeklyVerse() {
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 0);
      const diff = now - start;
      const oneDay = 1000 * 60 * 60 * 24;
      const dayOfYear = Math.floor(diff / oneDay);
      const weekIndex = Math.floor(dayOfYear / 7) % WEEKLY_VERSES.length;
      return WEEKLY_VERSES[weekIndex];
    }

    function showBlessing(verse) {
      fullBlessingOverlay.style.display = 'flex';
    }

    function closeBlessing() {
      fullBlessingOverlay.style.display = 'none';
      resetForm();
    }

    async function handleSave() {
      if (!currentEntry) return;

      saveBtn.disabled = true;
      saveBtn.textContent = "Saving...";

      const blessing = getWeeklyVerse();
      
      // 1. Determine if returning user
      const cleanInputPhone = (currentEntry.phone || "").replace(/\D/g, '').slice(-9);
      const cleanInputWhatsapp = (currentEntry.whatsapp || "").replace(/\D/g, '').slice(-9);
      
      let isReturning = false;
      if (Array.isArray(allRegistrations)) {
        isReturning = allRegistrations.some(reg => {
          const dbPhone = String(reg.phone || "").replace(/\D/g, '').slice(-9);
          const dbWhatsapp = String(reg.whatsapp || "").replace(/\D/g, '').slice(-9);
          return (cleanInputPhone && dbPhone === cleanInputPhone) || 
                 (cleanInputWhatsapp && dbWhatsapp === cleanInputWhatsapp);
        });
      }

      // 2. Prepare WhatsApp URL if needed
      let whatsappUrl = null;
      if (!isReturning) {
        let rawNumber = (currentEntry.whatsapp || currentEntry.phone).replace(/\D/g, '');
        if (rawNumber.startsWith('0')) {
          rawNumber = '256' + rawNumber.substring(1);
        } else if (rawNumber.length === 9 && (rawNumber.startsWith('7') || rawNumber.startsWith('3'))) {
          rawNumber = '256' + rawNumber;
        }

        let programMessage = 
          "Church Programs:\n" +
          "â€¢ Sunday Services: " + churchPrograms.sunday + "\n" +
          "â€¢ Monday Kyoto Prayers: " + churchPrograms.monday + "\n" +
          "â€¢ Wednesday Evening Glory: " + churchPrograms.wednesday + "\n" +
          "â€¢ Tue & Thu Counseling: " + churchPrograms.tueThu + "\n" +
          "â€¢ Friday Night Prayers: " + churchPrograms.friday;
        
        if (churchPrograms.custom && churchPrograms.custom.trim()) {
          programMessage += "\nâ€¢ " + churchPrograms.custom;
        }

        let messageText = "Hello " + currentEntry.name + "! Thank you for registering at Grace of Jesus Christ Ministries.\n\n" +
          "ðŸ•Š *A Blessing for you:* \"" + blessing + "\"\n\n" +
          programMessage;

        if (currentEntry.consent) {
          messageText += "\n\nJoin our WhatsApp Group: https://chat.whatsapp.com/Bd2AT6h45KgKMTUwCod89h";
        }

        messageText += "\n\nSubscribe to our YouTube: https://www.youtube.com/@encounter_GJM\n\n" +
          "*An encounter with the Holy Spirit*";

        if (isUpcomingBirthday(currentEntry.birthMonth, currentEntry.birthDay)) {
          messageText = "ðŸŽ‚ *Happy Birthday Month!* ðŸŽ‰\n\n" + messageText;
        }

        const message = encodeURIComponent(messageText);
        whatsappUrl = `https://wa.me/${rawNumber}?text=${message}`;
      }

      // 3. Save to database
      try {
        const params = new URLSearchParams();
        params.append('name', currentEntry.name);
        params.append('phone', currentEntry.phone);
        params.append('location', currentEntry.location);
        params.append('birthMonth', currentEntry.birthMonth || "");
        params.append('birthDay', currentEntry.birthDay || "");
        params.append('whatsapp', currentEntry.whatsapp || "");
        params.append('firstTime', currentEntry.firstTime || "");
        params.append('volunteering', currentEntry.volunteering.join(", ") || "");
        params.append('prayers', currentEntry.prayers.join(", "));

        // OPEN WHATSAPP IMMEDIATELY (Highest priority for browsers)
        if (whatsappUrl) {
          window.open(whatsappUrl, "_blank");
          // Add a backup link for the blessing screen
          const blessingPara = document.getElementById('blessingText');
          blessingPara.innerHTML = `"${blessing}"<br><br><a href="${whatsappUrl}" target="_blank" style="color:#25D366; font-size:1rem; font-weight:bold; text-decoration:none;">Click here to join WhatsApp if it didn't open!</a>`;
        } else {
          document.getElementById('blessingText').textContent = `"${blessing}"`;
        }

        const response = await fetch(REGISTER_API_URL, {
          method: 'POST',
          body: params.toString()
        });

        if (!response.ok) {
          const errorText = await response.text();
          let errorMessage = "Failed to save registration";
          try {
            const result = JSON.parse(errorText);
            errorMessage = result.error || errorMessage;
          } catch (e) {
            errorMessage = errorText || errorMessage;
          }
          throw new Error(errorMessage);
        }

        showBlessing(blessing);
      } catch (error) {
        console.error("Save error:", error);
        alert("âŒ Error saving: " + error.message);
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Registration";
      }
    }

    saveBtn.addEventListener('click', handleSave);

    function showConfirmation(data) {
      const birthStr = (data.birthMonth && data.birthDay) ? 
        `${data.birthMonth}/${data.birthDay}` : "â€”";
      const volStr = data.volunteering.length > 0 ? data.volunteering.join(", ") : "Not interested";
      
      detailsList.innerHTML = `
        <li><strong>Name:</strong> ${data.name}</li>
        <li><strong>Phone:</strong> ${data.phone}</li>
        <li><strong>Location:</strong> ${data.location}</li>
        <li><strong>Birthday:</strong> ${birthStr}</li>
        <li><strong>WhatsApp:</strong> ${data.whatsapp || "â€”"}</li>
        <li><strong>First Time Visitor:</strong> ${data.firstTime === 'yes' ? 'Yes' : 'No'}</li>
        <li><strong>Volunteer Interests:</strong> ${volStr}</li>
        <li><strong>Agreement:</strong> ${data.consent ? "Yes" : "No"}</li>
        <li><strong>Prayers:</strong> ${data.prayers.length > 0 ? data.prayers.join(", ") : "None"}</li>
      `;
      form.style.display = "none";
      confirmation.style.display = "block";
    }

    function resetForm() {
      form.reset();
      currentEntry = null;
      form.style.display = "flex";
      confirmation.style.display = "none";
      saveBtn.disabled = false;
      saveBtn.textContent = "Save Registration";
      prefetchData(); // Refresh local list
    }
  </script>
</body>
</html>
