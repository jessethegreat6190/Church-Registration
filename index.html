<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Church Counseling Registration</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#2c3e50">
  <link rel="apple-touch-icon" href="church logo/New Logo 2026.png">
  <style>
    :root {
      --primary-blue: #2c3e50;
      --secondary-blue: #3498db;
      --white: #ffffff;
      --light-gray: #f4f7f6;
      --success-green: #27ae60;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--white) 100%);
    }

    .container {
      background: var(--white);
      padding: 2rem;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
      width: 90%;
      max-width: 450px;
      margin: 20px;
      transition: all 0.3s ease;
    }

    .header {
      text-align: center;
      margin-bottom: 1.5rem;
    }

    .logo {
      max-width: 100px;
      height: auto;
      margin-bottom: 0.5rem;
      background: var(--primary-blue);
      padding: 8px;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    h1 {
      color: var(--primary-blue);
      font-size: 1.4rem;
      margin: 0;
    }

    .slogan {
      color: var(--secondary-blue);
      font-size: 0.9rem;
      margin-top: 5px;
      font-weight: 500;
    }

    form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-weight: 600;
      color: var(--primary-blue);
      font-size: 0.85rem;
    }

    input[type="text"],
    input[type="tel"],
    textarea {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
    }

    textarea {
      height: 60px;
      resize: vertical;
    }

    .checkbox-group {
      display: flex;
      flex-direction: row !important;
      align-items: center;
      gap: 10px;
      margin-top: 5px;
      background: #f8f9fa;
      padding: 10px;
      border-radius: 6px;
    }

    .checkbox-group input {
      width: 18px;
      height: 18px;
    }

    button {
      background: var(--secondary-blue);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 6px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    button:hover {
      background: #2980b9;
      transform: translateY(-2px);
    }

    button:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
    }

    #confirmation {
      display: none;
      animation: fadeIn 0.5s;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .details-card {
      background: var(--light-gray);
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }

    .details-card ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .details-card li {
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    /* Full-screen Blessing Overlay */
    #fullBlessingOverlay {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--white) 100%);
      z-index: 2000;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      padding: 1rem;
      box-sizing: border-box;
      overflow-y: auto;
    }

    .blessing-content {
      max-width: 500px;
      width: 95%;
      background: rgba(255, 255, 255, 0.95);
      padding: 3rem 2rem;
      border-radius: 20px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      animation: zoomIn 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @keyframes zoomIn {
      from { opacity: 0; transform: scale(0.9); }
      to { opacity: 1; transform: scale(1); }
    }

    .blessing-logo {
      max-width: 150px;
      margin-bottom: 2rem;
    }

    .thank-you-note {
      color: var(--success-green);
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 1rem;
    }

    .blessing-text {
      font-size: 1.4rem;
      font-style: italic;
      color: var(--primary-blue);
      line-height: 1.6;
      margin: 2rem 0;
      padding: 0 1rem;
    }

    .slogan-footer {
      color: var(--secondary-blue);
      font-weight: 600;
      margin-top: 2rem;
      font-size: 1.1rem;
    }

    .done-btn {
      margin-top: 3rem;
      padding: 15px 40px;
      font-size: 1.2rem;
      background: var(--success-green);
    }

    @media (max-width: 480px) {
      .container { padding: 1.5rem; }
      h1 { font-size: 1.25rem; }
      .thank-you-note { font-size: 1.5rem; }
      .blessing-text { font-size: 1.1rem; }
    }
  </style>
</head>
<body>

  <div class="container">
    <div class="header">
      <img src="church logo/New Logo 2026.png" alt="Church Logo" class="logo">
      <h1>Counseling Registration</h1>
      <div class="slogan">An encounter with the Holy Spirit</div>
    </div>

    <form id="registrationForm">
      <div class="form-group">
        <label for="name">Full Name</label>
        <input type="text" id="name" placeholder="Enter your name" required>
      </div>

      <div class="form-group">
        <label for="phone">Phone Number</label>
        <input type="tel" id="phone" placeholder="e.g. 0700000000" required>
      </div>

      <div class="form-group">
        <label for="location">Location</label>
        <input type="text" id="location" placeholder="Where do you live?" required>
      </div>

      <div class="form-group">
        <label for="whatsapp">WhatsApp Number (Optional)</label>
        <input type="tel" id="whatsapp" placeholder="e.g. 0700000000">
        <div style="text-align: center; margin-top: 15px; padding: 15px; border: 2px dashed #25D366; border-radius: 10px; background: #fff;">
          <p style="color: #128C7E; font-size: 0.9rem; margin-bottom: 10px; font-weight: bold;">
            SCAN TO JOIN OUR WHATSAPP GROUP
          </p>
          <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=https://chat.whatsapp.com/Bd2AT6h45KgKMTUwCod89h" 
               alt="WhatsApp Group QR Code" 
               style="width: 160px; height: 160px; border: 4px solid #f4f7f6; border-radius: 8px;">
          <p style="font-size: 0.7rem; color: #666; margin-top: 8px;">
            Scan this to join our official church group.
          </p>
        </div>
      </div>

      <div class="form-group checkbox-group">
        <input type="checkbox" id="consent" checked>
        <label for="consent" style="cursor: pointer;">Agree to be added to WhatsApp & receive messages</label>
      </div>

      <div class="form-group">
        <label for="prayers">Prayer Requests (Optional)</label>
        <textarea id="prayers" placeholder="Tell us how we can pray for you..."></textarea>
      </div>

      <button type="submit" id="submitBtn">Done Registering</button>
    </form>

    <div id="confirmation">
      <div style="text-align: center;">
        <h2 style="color: var(--primary-blue); margin-top: 0;">Confirm Your Details</h2>
        <p>Ensure your information is correct before saving.</p>
      </div>
      <div class="details-card">
        <ul id="detailsList"></ul>
      </div>
      <button id="saveBtn" style="width: 100%; background: var(--success-green); margin-bottom: 10px;">Save Registration</button>
      <button id="editBtn" style="width: 100%; background: var(--primary-blue);">Edit Details</button>
    </div>
  </div>

  <div id="fullBlessingOverlay">
    <div class="blessing-content">
      <img src="church logo/New Logo 2026.png" alt="Church Logo" class="blessing-logo">
      <div class="thank-you-note">Thank You for Registering!</div>
      <p id="blessingText" class="blessing-text"></p>
      <div class="slogan-footer">An encounter with the Holy Spirit</div>
      <button class="done-btn" onclick="closeBlessing()">Amen</button>
    </div>
  </div>

  <script>
    const REGISTER_API_URL = '/.netlify/functions/register';
    const GET_DATA_API_URL = '/.netlify/functions/get-data';
    
    const form = document.getElementById('registrationForm');
    const submitBtn = document.getElementById('submitBtn');
    const confirmation = document.getElementById('confirmation');
    const detailsList = document.getElementById('detailsList');
    const saveBtn = document.getElementById('saveBtn');
    const editBtn = document.getElementById('editBtn');
    const fullBlessingOverlay = document.getElementById('fullBlessingOverlay');
    
    let currentEntry = null;
    let allRegistrations = [];
    let churchPrograms = {
      sunday: "8:00 AM",
      monday: "7:00 AM - 9:00 AM",
      wednesday: "Evening Glory 5pm-7pm",
      tueThu: "7:00 AM - 3:00 PM",
      friday: "3pm, 2am, 3am (Not overnight)"
    };

    // Pre-fetch registrations & programs
    async function prefetchData() {
      try {
        const response = await fetch(GET_DATA_API_URL);
        if (response.ok) {
          const data = await response.json();
          allRegistrations = data.filter(reg => reg.name !== "SYSTEM_PROGRAMS");
          
          const progData = data.find(reg => reg.name === "SYSTEM_PROGRAMS");
          if (progData && progData.location) {
            try {
              churchPrograms = JSON.parse(progData.location);
              // Ensure wednesday exists for old saved programs
              if (!churchPrograms.wednesday) churchPrograms.wednesday = "Evening Glory 5pm-7pm";
            } catch (e) { console.error("Error parsing programs", e); }
          }
        }
      } catch (e) {
        console.error("Could not fetch existing data", e);
      }
    }
    prefetchData();

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registered'))
          .catch(err => console.log('SW registration failed', err));
      });
    }

    function handleReview(e) {
      e.preventDefault();
      
      const prayerText = document.getElementById('prayers').value;
      const prayerList = prayerText.split('\n').filter(line => line.trim() !== "");

      // Format name: First Letter Capital, others small for each word
      const rawName = document.getElementById('name').value.trim();
      const formattedName = rawName.toLowerCase()
        .split(' ')
        .filter(word => word.length > 0)
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');

      currentEntry = {
        name: formattedName,
        phone: document.getElementById('phone').value.trim(),
        location: document.getElementById('location').value.trim(),
        whatsapp: document.getElementById('whatsapp').value.trim() || null,
        consent: document.getElementById('consent').checked,
        prayers: prayerList
      };

      showConfirmation(currentEntry);
    }

    form.addEventListener('submit', handleReview);
    editBtn.addEventListener('click', () => {
      form.style.display = "flex";
      confirmation.style.display = "none";
    });

    const WEEKLY_VERSES = [
      "The Lord bless you and keep you; the Lord make his face shine on you and be gracious to you. (Numbers 6:24-25)",
      "For I know the plans I have for you, declares the Lord, plans to prosper you and not to harm you. (Jeremiah 29:11)",
      "The Lord is my shepherd; I shall not want. He makes me lie down in green pastures. (Psalm 23:1-2)",
      "Trust in the Lord with all your heart and lean not on your own understanding. (Proverbs 3:5)",
      "But those who hope in the Lord will renew their strength. They will soar on wings like eagles. (Isaiah 40:31)",
      "The Lord your God is with you, the Mighty Warrior who saves. He will take great delight in you. (Zephaniah 3:17)",
      "I can do all this through him who gives me strength. (Philippians 4:13)",
      "And my God will meet all your needs according to the riches of his glory in Christ Jesus. (Philippians 4:19)"
    ];

    function getWeeklyVerse() {
      const now = new Date();
      const start = new Date(now.getFullYear(), 0, 0);
      const diff = now - start;
      const oneDay = 1000 * 60 * 60 * 24;
      const dayOfYear = Math.floor(diff / oneDay);
      const weekIndex = Math.floor(dayOfYear / 7) % WEEKLY_VERSES.length;
      return WEEKLY_VERSES[weekIndex];
    }

    function showBlessing(verse) {
      document.getElementById('blessingText').textContent = "\"" + verse + "\"";
      fullBlessingOverlay.style.display = 'flex';
    }

    function closeBlessing() {
      fullBlessingOverlay.style.display = 'none';
      resetForm();
    }

    async function handleSave() {
      if (!currentEntry) return;

      saveBtn.disabled = true;
      saveBtn.textContent = "Saving...";

      const blessing = getWeeklyVerse();
      
      // Check if user is returning (robust check using digits only)
      const cleanInputPhone = currentEntry.phone.replace(/\D/g, '');
      const cleanInputWhatsapp = (currentEntry.whatsapp || "").replace(/\D/g, '');
      
      const isReturning = allRegistrations.some(reg => {
        const dbPhone = (reg.phone || "").toString().replace(/\D/g, '');
        const dbWhatsapp = (reg.whatsapp || "").toString().replace(/\D/g, '');
        
        const phoneMatch = dbPhone && dbPhone.includes(cleanInputPhone) || (cleanInputPhone && cleanInputPhone.includes(dbPhone));
        const whatsappMatch = cleanInputWhatsapp && (dbWhatsapp && dbWhatsapp.includes(cleanInputWhatsapp) || cleanInputWhatsapp.includes(dbWhatsapp));
        
        return phoneMatch || whatsappMatch;
      });

      // Only send WhatsApp if: 1. Consent is given, 2. Not a returning user (or if using different contact which is handled by the check above)
      if (currentEntry.consent && !isReturning) {
        let rawNumber = (currentEntry.whatsapp || currentEntry.phone).replace(/\D/g, '');
        if (rawNumber.startsWith('0')) {
          rawNumber = '256' + rawNumber.substring(1);
        } else if (rawNumber.length === 9 && (rawNumber.startsWith('7') || rawNumber.startsWith('3'))) {
          rawNumber = '256' + rawNumber;
        }

        const programMessage = 
          "Church Programs:\n" +
          "‚Ä¢ Sunday Services: " + churchPrograms.sunday + "\n" +
          "‚Ä¢ Monday Kyoto Prayers: " + churchPrograms.monday + "\n" +
          "‚Ä¢ Wednesday Evening Glory: " + churchPrograms.wednesday + "\n" +
          "‚Ä¢ Tue & Thu Counseling: " + churchPrograms.tueThu + "\n" +
          "‚Ä¢ Friday Night Prayers: " + churchPrograms.friday;

        const message = encodeURIComponent(
          "Hello " + currentEntry.name + "! Thank you for registering at Grace of Jesus Christ Ministries.\n\n" +
          "üïä *A Blessing for you:* \"" + blessing + "\"\n\n" +
          programMessage + "\n\n" +
          "Join our WhatsApp Group: https://chat.whatsapp.com/Bd2AT6h45KgKMTUwCod89h\n\n" +
          "Subscribe to our YouTube: https://www.youtube.com/@encounter_GJMchanled\n\n" +
          "*An encounter with the Holy Spirit*"
        );
        const whatsappUrl = `https://wa.me/${rawNumber}?text=${message}`;
        window.open(whatsappUrl, "_blank");
      }

      try {
        const params = new URLSearchParams();
        params.append('name', currentEntry.name);
        params.append('phone', currentEntry.phone);
        params.append('location', currentEntry.location);
        params.append('whatsapp', currentEntry.whatsapp || "");
        params.append('prayers', currentEntry.prayers.join(", "));
        params.append('timestamp', new Date().toISOString());

        await fetch(REGISTER_API_URL, {
          method: 'POST',
          body: params.toString()
        });

        showBlessing(blessing);
      } catch (error) {
        alert("‚ùå Error saving: " + error.message);
        saveBtn.disabled = false;
        saveBtn.textContent = "Save Registration";
      }
    }

    saveBtn.addEventListener('click', handleSave);

    function showConfirmation(data) {
      detailsList.innerHTML = `
        <li><strong>Name:</strong> ${data.name}</li>
        <li><strong>Phone:</strong> ${data.phone}</li>
        <li><strong>Location:</strong> ${data.location}</li>
        <li><strong>WhatsApp:</strong> ${data.whatsapp || "‚Äî"}</li>
        <li><strong>Agreement:</strong> ${data.consent ? "Yes" : "No"}</li>
        <li><strong>Prayers:</strong> ${data.prayers.length > 0 ? data.prayers.join(", ") : "None"}</li>
      `;
      form.style.display = "none";
      confirmation.style.display = "block";
    }

    function resetForm() {
      form.reset();
      currentEntry = null;
      form.style.display = "flex";
      confirmation.style.display = "none";
      saveBtn.disabled = false;
      saveBtn.textContent = "Save Registration";
      prefetchData(); // Refresh local list
    }
  </script>
</body>
</html>
